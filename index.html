<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<title>لعبة سباق سيارات أونلاين بسيطة</title>
<style>
  body {
    margin: 0; padding: 0;
    display: flex; flex-direction: column;
    align-items: center;
    background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
    color: white;
    font-family: Arial, sans-serif;
    user-select: none;
  }
  #menu {
    margin: 10px;
  }
  button, input {
    font-size: 16px;
    padding: 8px 12px;
    margin: 5px;
    border-radius: 6px;
    border: none;
  }
  button {
    background-color: #0ff;
    color: #000;
    cursor: pointer;
  }
  button:hover {
    background-color: #06c;
    color: #fff;
  }
  #info {
    margin-top: 10px;
  }
  #timer {
    font-size: 20px;
    margin-top: 10px;
  }
  #screens {
    display: flex;
    gap: 20px;
  }
  canvas {
    background: #222;
    border-radius: 15px;
    box-shadow: 0 0 10px #0ff;
    width: 400px;
    height: 600px;
  }
</style>
</head>
<body>

<div id="menu">
  <button onclick="createRoom()">إنشاء غرفة</button>
  <input id="roomInput" placeholder="كود الغرفة" />
  <button onclick="joinRoom()">دخول</button>
  <div id="info"></div>
  <div id="timer"></div>
</div>

<div id="screens">
  <canvas id="canvasMe" width="400" height="600"></canvas>
  <canvas id="canvasOpponent" width="400" height="600"></canvas>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
  // Firebase config - عدل بياناتك هنا:
  const firebaseConfig = {
    apiKey: "AIzaSyBxVQrmhcSVI1G2iApG8qVjBO27xzgPz6c",
    authDomain: "car-games-b8c76.firebaseapp.com",
    databaseURL: "https://car-games-b8c76-default-rtdb.firebaseio.com",
    projectId: "car-games-b8c76",
    storageBucket: "car-games-b8c76.firebasestorage.app",
    messagingSenderId: "317737401071",
    appId: "1:317737401071:web:0fe000d9f461d03e98b91a",
    measurementId: "G-KSYXCXH2FH"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // المتغيرات
  let room = null;
  let playerId = Math.random().toString(36).substr(2, 6);
  let joined = false;

  // عناصر
  const info = document.getElementById('info');
  const timer = document.getElementById('timer');
  const canvasMe = document.getElementById('canvasMe');
  const ctxMe = canvasMe.getContext('2d');
  const canvasOpponent = document.getElementById('canvasOpponent');
  const ctxOpponent = canvasOpponent.getContext('2d');

  // مضمار
  const trackMargin = 50;
  const trackWidth = 300;
  const trackHeight = 580;
  const obstacles = [
    {x: 150, y: 150, w: 40, h: 40},
    {x: 280, y: 300, w: 40, h: 40},
    {x: 100, y: 450, w: 40, h: 40}
  ];

  // سيارة
  class Car {
    constructor(x, y, color){
      this.x = x;
      this.y = y;
      this.color = color;
      this.width = 50;
      this.height = 40;
      this.speed = 0;
    }
    draw(ctx){
      ctx.fillStyle = this.color;
      ctx.beginPath();
      ctx.moveTo(this.x, this.y);
      ctx.lineTo(this.x + 40, this.y);
      ctx.lineTo(this.x + 50, this.y + 20);
      ctx.lineTo(this.x + 40, this.y + 40);
      ctx.lineTo(this.x, this.y + 40);
      ctx.lineTo(this.x - 10, this.y + 20);
      ctx.closePath();
      ctx.fill();
      ctx.fillStyle = 'rgba(135,206,250,0.7)';
      ctx.fillRect(this.x + 10, this.y + 10, 20, 15);
    }
    update(){
      this.y += this.speed;
      if(this.y < 0) this.y = 0;
      if(this.y > trackHeight - this.height) this.y = trackHeight - this.height;
      if(this.x < trackMargin) this.x = trackMargin;
      if(this.x > trackMargin + trackWidth - this.width) this.x = trackMargin + trackWidth - this.width;
    }
    collidesWith(ob){
      return !(this.x + this.width < ob.x || this.x > ob.x + ob.w || this.y + this.height < ob.y || this.y > ob.y + ob.h);
    }
  }

  let playerCar = new Car(trackMargin + 50, trackHeight - 80, '#e63946');
  let opponentCar = new Car(trackMargin + 150, trackHeight - 80, '#1d3557');

  // تحكم المفاتيح
  const keys = {};
  window.addEventListener('keydown', e => keys[e.key] = true);
  window.addEventListener('keyup', e => keys[e.key] = false);

  // مؤقت
  let raceDuration = 60;
  let raceStartTime = null;
  let raceEnded = false;

  // انشاء غرفة
  function createRoom(){
    room = Math.floor(Math.random()*90000+10000).toString();
    db.ref('rooms/'+room).set({});
    info.textContent = `تم إنشاء الغرفة. كود الغرفة: ${room}`;
  }

  // دخول غرفة
  function joinRoom(){
    const code = document.getElementById('roomInput').value.trim();
    if(!code) return alert('أدخل كود الغرفة');
    room = code;
    joined = true;
    info.textContent = `دخلت الغرفة: ${room}. أنت اللاعب ${playerId}`;
    raceStartTime = Date.now();
    db.ref('rooms/'+room+'/'+playerId).set({
      x: playerCar.x,
      y: playerCar.y
    });
    listenRoom();
    gameLoop();
  }

  // استماع لتحديثات الغرفة
  function listenRoom(){
    db.ref('rooms/'+room).on('value', snapshot=>{
      const val = snapshot.val()||{};
      for(let id in val){
        if(id !== playerId){
          opponentCar.x = val[id].x;
          opponentCar.y = val[id].y;
        }
      }
    });
  }

  // تحديث موقع السيارة وإرسالها للفيربيز
  function updatePlayerCar(){
    if(keys['ArrowUp']) playerCar.speed = -5;
    else if(keys['ArrowDown']) playerCar.speed = 5;
    else playerCar.speed = 0;

    if(keys['ArrowLeft']) playerCar.x -= 5;
    if(keys['ArrowRight']) playerCar.x += 5;

    playerCar.update();

    // تحقق من الاصطدام
    for(let ob of obstacles){
      if(playerCar.collidesWith(ob)){
        playerCar.y += 10; // ارتداد للخلف
      }
    }

    if(joined && room){
      db.ref('rooms/'+room+'/'+playerId).set({
        x: playerCar.x,
        y: playerCar.y
      });
    }
  }

  // رسم المضمار والعقبات
  function drawTrack(ctx){
    ctx.fillStyle = '#222';
    ctx.fillRect(0,0,canvasMe.width, canvasMe.height);

    ctx.fillStyle = '#333';
    ctx.fillRect(trackMargin, 0, trackWidth, trackHeight);

    // خطوط جانبية
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(trackMargin,0);
    ctx.lineTo(trackMargin,trackHeight);
    ctx.moveTo(trackMargin+trackWidth,0);
    ctx.lineTo(trackMargin+trackWidth,trackHeight);
    ctx.stroke();

    // خطوط المسارات المتقطعة
    ctx.lineWidth = 1;
    ctx.setLineDash([15,10]);
    for(let i=1; i<3; i++){
      let x = trackMargin + laneWidth*i;
      ctx.beginPath();
      ctx.moveTo(x,0);
      ctx.lineTo(x,trackHeight);
      ctx.stroke();
    }
    ctx.setLineDash([]);

    // رسم العقبات
    for(let ob of obstacles){
      ctx.fillStyle = '#a0522d';
      ctx.fillRect(ob.x, ob.y, ob.w, ob.h);
      ctx.strokeStyle = '#fff';
      ctx.strokeRect(ob.x, ob.y, ob.w, ob.h);
    }
  }

  // عرض المؤقت
  function updateTimer(){
    if(!raceStartTime) return;
    let elapsed = Math.floor((Date.now() - raceStartTime)/1000);
    let remaining = raceDuration - elapsed;
    if(remaining <= 0){
      raceEnded = true;
      timer.textContent = "انتهى السباق!";
    } else {
      timer.textContent = `الوقت المتبقي: ${remaining} ثانية`;
    }
  }

  // رسم الشاشات
  function draw(){
    // شاشتي
    ctxMe.clearRect(0,0,canvasMe.width, canvasMe.height);
    drawTrack(ctxMe);
    playerCar.draw(ctxMe);

    // شاشة الخصم
    ctxOpponent.clearRect(0,0,canvasOpponent.width, canvasOpponent.height);
    drawTrack(ctxOpponent);
    opponentCar.draw(ctxOpponent);
  }

  // الحلقة الرئيسية
  function gameLoop(){
    if(raceEnded) return;
    updatePlayerCar();
    updateTimer();
    draw();
    requestAnimationFrame(gameLoop);
  }
</script>

</body>
</html>
